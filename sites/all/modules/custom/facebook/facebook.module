<?php

//define("FACEBOOK_APP_ID", "1035129189845262");
define("FACEBOOK_APP_ID", "1640010319548174");
//define("FACEBOOK_APP_SECRET", "1e121667b64b99f97148211d7df38a60");
define("FACEBOOK_APP_SECRET", "7d64b5c69e9b6759bf781fb4a4868622");
define("FACEBOOK_APP_REDIRECT_URL", "http://localhost/drupal_task_1/user/test?social=facebook");
define("FACEBOOK_DIALOG_URL", "https://www.facebook.com/dialog/oauth");
define("FACEBOOK_FEED", "https://graph.facebook.com/me/feed");

function facebook_entity_info() {
    $return = array(
        'facebook' => array(
            'label' => t('Facebook'),
            'entity class' => 'Facebook1',
            'controller class' => 'FacebookController',
            'base table' => 'facebook',
            'fieldable' => TRUE,
            'load hook' => 'facebook_load',
            'module' => 'facebook',
            'entity keys' => array(
                'id' => 'fid',
                'label' => ''
            ),
            'bundle keys' => array(
                'bundle' => 'name',
            ),
            'bundles' => array(),
            'view modes' => array(
                'full' => array(
                    'label' => t('Full'),
                    'custom settings' => FALSE,
                ),
                'admin' => array(
                    'label' => t('Admin'),
                    'custom settings' => TRUE,
                ),
            ),
            'label callback' => 'entity_class_label',
            'uri callback' => 'entity_class_uri',
        )
    );
    return $return;
}


function facebook_menu() {
    $items['admin/config/facebook'] = array(
        'title callback' => '',
        //'title arguments' => array('twitter', 1),
        'page callback' => 'facebook_page_view',
        //'page arguments' => array(1),
        //'access callback' => TRUE,
        'access arguments' => array('administer site configuration'),
        'file' => 'facebook.pages.inc',
    );
    return $items;
}

function facebook_load($twitter_id, $reset = FALSE) {
    $products = facebook_load_multiple(array($twitter_id), array(), $reset);
    return $products ? reset($products) : FALSE;
}

function facebook_load_multiple($product_ids = array(), $conditions = array(), $reset = FALSE) {
    return entity_load('facebook', $product_ids, $conditions, $reset);
}

function facebook_load_by_user() {
    global $user;
    $query = db_select('facebook', 'fb')
        ->fields('fb', array('fid'))
        ->condition('user_id', $user->uid);
    return $query->execute()->fetchField();
}

function facebook_get_auth_link() {
    $params = array(
        'client_id'     => FACEBOOK_APP_ID,
        'redirect_uri'  => FACEBOOK_APP_REDIRECT_URL,
        'response_type' => 'code',
        'scope'         => 'publish_actions, user_posts'
    );
    return FACEBOOK_DIALOG_URL . '?' . urldecode(http_build_query($params));
}

function facebook_get_posts() {
    global $user;
    $facebookAccessToken = db_select('facebook', 'fb')
        ->fields('fb', array('access_token'))
        ->condition('user_id', $user->uid)
        ->execute()
        ->fetchField();
    $params = array('access_token' => $facebookAccessToken);
    $feeds = json_decode(file_get_contents(FACEBOOK_FEED . '?' . urldecode(http_build_query($params))), true);
    /*$parsedFeeds = [];
    foreach($feeds->data as $index => $feed) {
        $text = isset($feed->message) ? $feed->message : $feed->story;
        $parsedFeeds[$index]['date_post'] = date('d/m/Y', $feed->created_time);
        $parsedFeeds[$index]['content'] = $text;
        $parsedFeeds[$index]['author'] = '';
    }
    return $parsedFeeds;*/
    var_dump($feeds);die;
}

function facebook_public_post($data) {
    global $user;
    $facebookAccessToken = db_select('facebook', 'fb')
        ->fields('fb', array('access_token'))
        ->condition('user_id', $user->uid)
        ->execute()
        ->fetchField();
    $params = array('access_token' => $facebookAccessToken);
    $module_path = drupal_get_path('module', 'facebook');
    require_once $module_path . '/FacebookHelper.php';
    $a = new FacebookHelper();
    var_dump($a->curlRequest(FACEBOOK_FEED . '?message=test&access_token=' . urldecode(http_build_query($params)), 'POST'));
}

function facebook_reset($id) {
    global $user;
    return db_delete('facebook')
        ->condition('user_id', $user->uid)
        ->condition('fid', $id)
        ->execute();
}